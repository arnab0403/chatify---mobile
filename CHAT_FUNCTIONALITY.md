# Real-Time Chat Functionality Setup

This guide explains the real-time chat implementation using Firebase Firestore and React Native.

## Architecture Overview

The chat system uses:
- **Firebase Firestore** for real-time message storage and synchronization
- **Firebase Snapshots** for real-time updates
- **React Hooks** for state management
- **Local State** for optimistic updates

## File Structure

```
services/messageService.ts     # Firestore operations and subscriptions
hooks/useMessages.ts           # Custom hook for message management
types/index.ts                 # TypeScript types for Message and Conversation
app/(app)/chat.tsx             # Chat screen component
```

## Database Collections

### Messages Collection
Stores individual chat messages:
```typescript
{
  id: string;                    // Auto-generated by Firestore
  conversationId: string;        // Generated from sorted user IDs
  senderId: string;              // UID of message sender
  senderName: string;            // Display name of sender
  text: string;                  // Message content
  timestamp: Timestamp;          // Server timestamp
  createdAt: Timestamp;          // Creation timestamp
}
```

### Conversations Collection (Optional)
Stores conversation metadata:
```typescript
{
  id: string;                              // Conversation ID
  participants: string[];                  // Array of user UIDs
  participantNames: { [key: string]: string }; // User names
  lastMessage: string;                     // Last message text
  lastMessageTimestamp: number;            // Last update time
  createdAt: number;                       // Creation time
  updatedAt: number;                       // Last update time
}
```

## Key Features

### 1. Real-Time Message Subscription
Messages are subscribed to using Firebase `onSnapshot`:
- Automatically updates when new messages arrive
- Ordered by timestamp
- Automatically unsubscribed when component unmounts

### 2. Message Sending
- Uses server timestamps for consistency
- Returns message ID after creation
- Handles errors gracefully

### 3. Conversation ID Generation
- Generates consistent IDs from two user IDs
- Sorted to ensure same ID regardless of order
- Format: `userId1_userId2` (sorted alphabetically)

## Usage Example

```tsx
import { useMessages } from "@/hooks/useMessages";
import { generateConversationId } from "@/services/messageService";

export default function ChatScreen() {
  const conversationId = generateConversationId(userId1, userId2);
  
  const { messages, loading, error, sendMessage } = useMessages({
    conversationId,
    senderId: currentUserId,
    senderName: currentUserName,
  });

  const handleSend = async (text: string) => {
    const success = await sendMessage(text);
    if (success) {
      // Message sent successfully
    }
  };

  return (
    // Render messages
  );
}
```

## Firebase Configuration

### Step 1: Enable Firestore
1. Go to Firebase Console
2. Navigate to Cloud Firestore
3. Create database in production mode
4. Set region (e.g., `us-central1`)

### Step 2: Update Security Rules
1. Go to Firestore → Rules
2. Copy rules from `firestore.rules`
3. Publish rules

### Step 3: Create Indexes (if needed)
Firestore may automatically create required indexes. If you get index errors:
1. Follow the link in the error
2. Create the suggested index

## Real-Time Updates Flow

```
┌─────────────────────────────────┐
│  User Types Message             │
└──────────────┬──────────────────┘
               │
               ▼
┌─────────────────────────────────┐
│  handleSendMessage() Called      │
└──────────────┬──────────────────┘
               │
               ▼
┌─────────────────────────────────┐
│  sendMessage() → Firestore      │
└──────────────┬──────────────────┘
               │
               ▼
┌─────────────────────────────────┐
│  onSnapshot Listener Triggered  │
└──────────────┬──────────────────┘
               │
               ▼
┌─────────────────────────────────┐
│  Messages State Updated         │
└──────────────┬──────────────────┘
               │
               ▼
┌─────────────────────────────────┐
│  Component Re-Renders           │
└─────────────────────────────────┘
```

## Performance Optimization

### 1. Message Pagination (Future Enhancement)
```typescript
// Query only last N messages
const q = query(
  messagesRef,
  where("conversationId", "==", conversationId),
  orderBy("timestamp", "desc"),
  limit(50)
);
```

### 2. Unsubscribe on Unmount
The hook automatically unsubscribes from Firestore listeners when the component unmounts to prevent memory leaks.

### 3. Error Handling
All async operations include try-catch blocks with user-friendly error messages.

## Troubleshooting

### Messages not appearing?
1. Check Firestore rules allow your user to read messages
2. Verify `conversationId` is generated consistently
3. Check browser console for errors

### Real-time not working?
1. Ensure user is authenticated
2. Check network connection
3. Verify Firestore is enabled in Firebase Console

### Slow performance?
1. Implement message pagination
2. Add indexing to Firestore queries
3. Consider reducing message query limit

## Future Enhancements

- [ ] Message pagination/infinite scroll
- [ ] Typing indicators
- [ ] Message reactions/emojis
- [ ] Message editing
- [ ] Message deletion with soft-delete
- [ ] Message search functionality
- [ ] Image/file sharing
- [ ] Voice messages
- [ ] End-to-end encryption
